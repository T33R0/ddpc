# Current RLS Policies

**Last Updated**: Most current database state

| schemaname | tablename             | policyname                               | permissive | cmd    | qual                                                                                                                                                                                                                | with_check                                                                                                                                                                                                          |
| ---------- | --------------------- | ---------------------------------------- | ---------- | ------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| public     | ai_embeddings         | ai_embeddings_service_only_all           | PERMISSIVE | ALL    | (auth.role() = 'service_role'::text)                                                                                                                                                                                | (auth.role() = 'service_role'::text)                                                                                                                                                                                |
| public     | ai_memory_kv          | ai_memory_kv_service_only_all            | PERMISSIVE | ALL    | (auth.role() = 'service_role'::text)                                                                                                                                                                                | (auth.role() = 'service_role'::text)                                                                                                                                                                                |
| public     | ai_prompts            | ai_prompts_service_only_all              | PERMISSIVE | ALL    | (auth.role() = 'service_role'::text)                                                                                                                                                                                | (auth.role() = 'service_role'::text)                                                                                                                                                                                |
| public     | ai_session            | ai_session_service_only_all              | PERMISSIVE | ALL    | (auth.role() = 'service_role'::text)                                                                                                                                                                                | (auth.role() = 'service_role'::text)                                                                                                                                                                                |
| public     | ai_turn               | ai_turn_service_only_all                 | PERMISSIVE | ALL    | (auth.role() = 'service_role'::text)                                                                                                                                                                                | (auth.role() = 'service_role'::text)                                                                                                                                                                                |
| public     | user_profile          | up_insert_self                           | PERMISSIVE | INSERT | null                                                                                                                                                                                                                | (auth.uid() = user_id)                                                                                                                                                                                              |
| public     | user_profile          | up_read_public                           | PERMISSIVE | SELECT | (is_public = true)                                                                                                                                                                                                  | null                                                                                                                                                                                                                |
| public     | user_profile          | up_read_self                             | PERMISSIVE | SELECT | (auth.uid() = user_id)                                                                                                                                                                                              | null                                                                                                                                                                                                                |
| public     | user_profile          | up_select_self                           | PERMISSIVE | SELECT | (auth.uid() = user_id)                                                                                                                                                                                              | null                                                                                                                                                                                                                |
| public     | user_profile          | up_service_all                           | PERMISSIVE | ALL    | (auth.role() = 'service_role'::text)                                                                                                                                                                                | (auth.role() = 'service_role'::text)                                                                                                                                                                                |
| public     | user_profile          | up_update_admin                          | PERMISSIVE | UPDATE | (((auth.jwt() ->> 'role'::text) = 'service_role'::text) OR (EXISTS ( SELECT 1
   FROM user_profile user_profile_1
  WHERE ((user_profile_1.user_id = auth.uid()) AND (user_profile_1.role = 'admin'::user_role))))) | (((auth.jwt() ->> 'role'::text) = 'service_role'::text) OR (EXISTS ( SELECT 1
   FROM user_profile user_profile_1
  WHERE ((user_profile_1.user_id = auth.uid()) AND (user_profile_1.role = 'admin'::user_role))))) |
| public     | user_profile          | up_update_self                           | PERMISSIVE | UPDATE | (auth.uid() = user_id)                                                                                                                                                                                              | (auth.uid() = user_id)                                                                                                                                                                                              |
| public     | user_profile          | zz_combined_select                       | PERMISSIVE | SELECT | ((( SELECT auth.uid() AS uid) = user_id) OR (is_public = true))                                                                                                                                                     | null                                                                                                                                                                                                                |
| public     | user_vehicle          | Users can manage their own vehicles      | PERMISSIVE | ALL    | (owner_id = auth.uid())                                                                                                                                                                                             | null                                                                                                                                                                                                                |
| public     | user_vehicle          | Users can view their own vehicles        | PERMISSIVE | SELECT | (owner_id = auth.uid())                                                                                                                                                                                             | null                                                                                                                                                                                                                |
| public     | user_vehicle          | public read vehicles with privacy=public | PERMISSIVE | SELECT | (privacy = 'public'::text)                                                                                                                                                                                          | null                                                                                                                                                                                                                |
| public     | user_vehicle          | vehicle_select_public                    | PERMISSIVE | SELECT | (privacy = 'public'::text)                                                                                                                                                                                          | null                                                                                                                                                                                                                |
| public     | vehicle_data          | read vehicle_data                        | PERMISSIVE | SELECT | true                                                                                                                                                                                                                | null                                                                                                                                                                                                                |
| public     | vehicle_data          | vd_read                                  | PERMISSIVE | SELECT | true                                                                                                                                                                                                                | null                                                                                                                                                                                                                |
| public     | vehicle_image_archive | via_delete_service_only                  | PERMISSIVE | DELETE | (auth.role() = 'service_role'::text)                                                                                                                                                                                | null                                                                                                                                                                                                                |
| public     | vehicle_image_archive | via_insert_service_only                  | PERMISSIVE | INSERT | null                                                                                                                                                                                                                | (auth.role() = 'service_role'::text)                                                                                                                                                                                |
| public     | vehicle_image_archive | via_select_public                        | PERMISSIVE | SELECT | true                                                                                                                                                                                                                | null                                                                                                                                                                                                                |
| public     | vehicle_image_archive | via_update_service_only                  | PERMISSIVE | UPDATE | (auth.role() = 'service_role'::text)                                                                                                                                                                                | (auth.role() = 'service_role'::text)                                                                                                                                                                                |
| public     | vehicle_primary_image | vpi_delete_service_only                  | PERMISSIVE | DELETE | (auth.role() = 'service_role'::text)                                                                                                                                                                                | null                                                                                                                                                                                                                |
| public     | vehicle_primary_image | vpi_insert_service_only                  | PERMISSIVE | INSERT | null                                                                                                                                                                                                                | (auth.role() = 'service_role'::text)                                                                                                                                                                                |
| public     | vehicle_primary_image | vpi_select_public                        | PERMISSIVE | SELECT | true                                                                                                                                                                                                                | null                                                                                                                                                                                                                |
| public     | vehicle_primary_image | vpi_update_service_only                  | PERMISSIVE | UPDATE | (auth.role() = 'service_role'::text)                                                                                                                                                                                | (auth.role() = 'service_role'::text)                                                                                                                                                                                |
| public     | vehicle_url_queue     | vuq_service_only_all                     | PERMISSIVE | ALL    | (auth.role() = 'service_role'::text)                                                                                                                                                                                | (auth.role() = 'service_role'::text)                                                                                                                                                                                |

## Notes
- **AI TABLES**: Service role only access for security
- **USER VEHICLES**: Direct ownership-based access (owner_id = auth.uid())
- **PUBLIC ACCESS**: Vehicles with privacy='public' can be viewed by anyone
- **SERVICE OPERATIONS**: Service role has full access to system tables
