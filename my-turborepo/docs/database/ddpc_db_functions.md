| function_name                       | arguments                                                                                                                                                                                                                                                                                                                                                                                                                                           | definition                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| ----------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| activity_log_write                  | p_user_id uuid, p_entity_type text, p_entity_id uuid, p_diff jsonb                                                                                                                                                                                                                                                                                                                                                                                  | CREATE OR REPLACE FUNCTION public.activity_log_write(p_user_id uuid, p_entity_type text, p_entity_id uuid, p_diff jsonb)
 RETURNS void
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public', 'extensions', 'pg_temp'
AS $function$
begin
  insert into public.activity_log(user_id, entity_type, entity_id, diff)
  values (p_user_id, p_entity_type, p_entity_id, p_diff);
end;$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| add_event_for_vehicle_legacy        | _vehicle_id uuid, _type text, _title text, _occurred_on date, _notes text DEFAULT NULL::text                                                                                                                                                                                                                                                                                                                                                        | CREATE OR REPLACE FUNCTION public.add_event_for_vehicle_legacy(_vehicle_id uuid, _type text, _title text, _occurred_on date, _notes text DEFAULT NULL::text)
 RETURNS uuid
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
declare
  _eid uuid;
begin
  if not public.is_vehicle_owner(_vehicle_id) then
    raise exception 'not_owner';
  end if;

  insert into public.event (id, vehicle_id, type, title, occurred_on, notes, created_by)
  values (gen_random_uuid(), _vehicle_id, _type, _title, _occurred_on, _notes, auth.uid())
  returning id into _eid;

  insert into public.bot_action_log(session_id, action, args, result, status)
    values (
      null,
      'garage.add_event_legacy',
      jsonb_build_object('vehicle_id', _vehicle_id, 'type', _type, 'title', _title, 'occurred_on', _occurred_on),
      jsonb_build_object('event_id', _eid),
      'ok'
    );

  return _eid;
end
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| add_part_change_event               |                                                                                                                                                                                                                                                                                                                                                                                                                                                     | CREATE OR REPLACE FUNCTION public.add_part_change_event()
 RETURNS trigger
 LANGUAGE plpgsql
 SET search_path TO 'public', 'pg_temp'
AS $function$
declare
  _eid uuid;
  _title text;
begin
  if tg_op = 'INSERT' then
    -- Skip baseline seeds
    if new.source = 'seed' then
      return new;
    end if;

    select
      'Installed ' ||
      coalesce((select pc.brand || ' ' || pc.name from public.parts_catalog pc where pc.id = new.catalog_id), 'part') ||
      ' on ' || new.slot_label
    into _title;

    insert into public.events(
      vehicle_id, type, title, occurred_on, date_confidence, payload, created_by
    )
    values (
      new.vehicle_id,
      'part_change',                                   -- your events.type enum must include this
      _title,
      new.valid_from::date,
      (case when new.valid_from is null
            then 'unknown'::public.date_confidence
            else 'exact'::public.date_confidence end),
      jsonb_build_object('slot_code', new.slot_code, 'part_state_id', new.id),
      new.created_by
    )
    returning id into _eid;

    insert into public.event_entities(event_id, part_state_id)
    values (_eid, new.id);
  end if;

  return new;
end
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| capture_repair_issue                | _vehicle_id uuid, _summary text, _detail text DEFAULT NULL::text, _symptoms text[] DEFAULT NULL::text[]                                                                                                                                                                                                                                                                                                                                             | CREATE OR REPLACE FUNCTION public.capture_repair_issue(_vehicle_id uuid, _summary text, _detail text DEFAULT NULL::text, _symptoms text[] DEFAULT NULL::text[])
 RETURNS jsonb
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
declare
  _task uuid;
  _event uuid;
begin
  if not public.is_vehicle_owner(_vehicle_id) then
    raise exception 'not_owner';
  end if;

  -- Diagnostic task
  insert into public.work_items (id, vehicle_id, title, status, tags, created_by)
  values (gen_random_uuid(), _vehicle_id, concat('Diagnose: ', _summary), 'open', array['diagnostic'], auth.uid())
  returning id into _task;

  -- Log event (legacy table)
  insert into public.event (id, vehicle_id, type, title, occurred_on, notes, created_by)
  values (gen_random_uuid(), _vehicle_id, 'INSPECT', _summary, current_date, _detail, auth.uid())
  returning id into _event;

  -- Audit
  insert into public.bot_action_log(session_id, action, args, result, status)
    values (
      null,
      'repair.capture_issue',
      jsonb_build_object('vehicle_id', _vehicle_id, 'summary', _summary, 'symptoms', _symptoms),
      jsonb_build_object('work_item_id', _task, 'event_id', _event),
      'ok'
    );

  return jsonb_build_object('work_item_id', _task, 'event_id', _event);
end
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| cleanup_old_bot_sessions            |                                                                                                                                                                                                                                                                                                                                                                                                                                                     | CREATE OR REPLACE FUNCTION public.cleanup_old_bot_sessions()
 RETURNS integer
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public', 'extensions', 'pg_temp'
AS $function$
DECLARE
  deleted_count INTEGER;
BEGIN
  DELETE FROM bot_session
  WHERE created_at < NOW() - INTERVAL '30 days'
  AND user_id IS NULL; -- Only delete anonymous sessions

  GET DIAGNOSTICS deleted_count = ROW_COUNT;
  RETURN deleted_count;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| create_task_for_vehicle             | _vehicle_id uuid, _title text, _due_on date DEFAULT NULL::date, _tags text[] DEFAULT NULL::text[]                                                                                                                                                                                                                                                                                                                                                   | CREATE OR REPLACE FUNCTION public.create_task_for_vehicle(_vehicle_id uuid, _title text, _due_on date DEFAULT NULL::date, _tags text[] DEFAULT NULL::text[])
 RETURNS uuid
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
declare
  _id uuid;
begin
  if not public.is_vehicle_owner(_vehicle_id) then
    raise exception 'not_owner';
  end if;

  insert into public.work_items (id, vehicle_id, title, status, due_on, tags, created_by)
  values (gen_random_uuid(), _vehicle_id, _title, 'open', _due_on, coalesce(_tags, '{}'::text[]), auth.uid())
  returning id into _id;

  insert into public.bot_action_log(session_id, action, args, result, status)
    values (
      null,
      'garage.create_task',
      jsonb_build_object('vehicle_id', _vehicle_id, 'title', _title, 'due_on', _due_on, 'tags', _tags),
      jsonb_build_object('work_item_id', _id),
      'ok'
    );

  return _id;
end
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| create_vehicle_from_template        | p_template_id text, p_garage_id uuid, p_title text DEFAULT NULL::text                                                                                                                                                                                                                                                                                                                                                                               | CREATE OR REPLACE FUNCTION public.create_vehicle_from_template(p_template_id text, p_garage_id uuid, p_title text DEFAULT NULL::text)
 RETURNS uuid
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
declare v_new_id uuid;
begin
  if not exists (
    select 1 from public.garage_member gm
    where gm.garage_id = p_garage_id and gm.user_id = auth.uid()
  ) then
    raise exception 'Not a member of garage %', p_garage_id using errcode='42501';
  end if;

  insert into public.vehicle (
    id, garage_id, template_id, title,
    year, make, model, trim,
    spec_snapshot, privacy, current_status
  )
  select
    gen_random_uuid(), p_garage_id, vt.id,
    coalesce(p_title, concat(vt.year,' ',vt.make,' ',vt.model,
             case when vt.trim is null then '' else ' '||vt.trim end)),
    vt.year, vt.make, vt.model, vt.trim,
    to_jsonb(vt), 'private','daily_driver'
  from public.vehicle_template vt
  where vt.id = p_template_id
  returning id into v_new_id;

  return v_new_id;
end$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| current_odometer_for_vehicle        | p_user_vehicle_id uuid                                                                                                                                                                                                                                                                                                                                                                                                                              | CREATE OR REPLACE FUNCTION public.current_odometer_for_vehicle(p_user_vehicle_id uuid)
 RETURNS integer
 LANGUAGE sql
 STABLE
 SET search_path TO 'public', 'extensions', 'pg_temp'
AS $function$
  with last_log as (
    select reading_mi
    from public.odometer_log
    where user_vehicle_id = p_user_vehicle_id
    order by recorded_at desc
    limit 1
  )
  select coalesce(
    (select reading_mi from last_log),
    (select odometer from public.user_vehicle where id = p_user_vehicle_id),
    0
  );
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| emit_event                          | p_type event_type_category, p_vehicle_id uuid, p_title text, p_payload jsonb, p_build_plan_id uuid DEFAULT NULL::uuid                                                                                                                                                                                                                                                                                                                               | CREATE OR REPLACE FUNCTION public.emit_event(p_type event_type_category, p_vehicle_id uuid, p_title text, p_payload jsonb, p_build_plan_id uuid DEFAULT NULL::uuid)
 RETURNS uuid
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
declare
  v_event_id uuid;
  v_user uuid;
begin
  -- JWT user or system fallback
  select coalesce(auth.uid(), (select system_user_id from public.app_settings limit 1))
  into v_user;
  if v_user is null then
    raise exception 'emit_event(): no auth.uid() and no system_user_id configured';
  end if;

  -- CAST category -> type via text (requires 'build' to be present on event_type)
  insert into public.events (vehicle_id, type, title, occurred_on, date_confidence, payload, created_by)
  values (
    p_vehicle_id,
    (p_type::text)::public.event_type,
    p_title,
    current_date,
    'exact',
    coalesce(p_payload, '{}'::jsonb),
    v_user
  )
  returning id into v_event_id;

  if p_build_plan_id is not null then
    insert into public.event_entities (event_id, build_plan_id)
    values (v_event_id, p_build_plan_id)
    on conflict (event_id) do update set build_plan_id = excluded.build_plan_id;
  end if;

  return v_event_id;
end
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| enforce_open_plan_for_jobs          |                                                                                                                                                                                                                                                                                                                                                                                                                                                     | CREATE OR REPLACE FUNCTION public.enforce_open_plan_for_jobs()
 RETURNS trigger
 LANGUAGE plpgsql
 SET search_path TO 'public', 'pg_temp'
AS $function$
declare s text;
begin
  select status into s from public.build_plans where id = new.build_plan_id;
  if s is null then
    raise exception 'build_plan % not found', new.build_plan_id;
  end if;
  if s <> 'open' then
    raise exception 'cannot modify jobs on a % plan', s;
  end if;
  return new;
end $function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| enforce_preferred_vehicle_ownership |                                                                                                                                                                                                                                                                                                                                                                                                                                                     | CREATE OR REPLACE FUNCTION public.enforce_preferred_vehicle_ownership()
 RETURNS trigger
 LANGUAGE plpgsql
 SET search_path TO 'public', 'extensions', 'pg_temp'
AS $function$
begin
  if new.preferred_vehicle_id is null then
    return new;
  end if;

  if not exists (
    select 1
    from public.user_vehicle uv
    where uv.id = new.preferred_vehicle_id
      and uv.owner_id = new.user_id
  ) then
    raise exception 'preferred_vehicle_id must reference a vehicle owned by this user';
  end if;

  return new;
end
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| ensure_garage_for_current_user      |                                                                                                                                                                                                                                                                                                                                                                                                                                                     | CREATE OR REPLACE FUNCTION public.ensure_garage_for_current_user()
 RETURNS uuid
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
declare
  gid uuid;
begin
  insert into public.garage (owner_id, name)
  values (auth.uid(), 'Personal Garage')
  on conflict (owner_id) do update set name = excluded.name
  returning id into gid;

  -- Ensure membership as owner
  insert into public.garage_member (garage_id, user_id, role)
  values (gid, auth.uid(), 'OWNER')
  on conflict (garage_id, user_id) do update set role = 'OWNER';

  return gid;
end;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| fn_update_vehicle_last_event_at     |                                                                                                                                                                                                                                                                                                                                                                                                                                                     | CREATE OR REPLACE FUNCTION public.fn_update_vehicle_last_event_at()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public', 'extensions', 'pg_temp'
AS $function$
begin
  update public.user_vehicle
  set last_event_at = greatest(coalesce(last_event_at, to_timestamp(0)), new.created_at)
  where id = new.vehicle_id;
  return new;
end;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| get_admin_users_stats               | limit_offset integer DEFAULT 0, limit_count integer DEFAULT 20, search_query text DEFAULT NULL::text                                                                                                                                                                                                                                                                                                                                                | CREATE OR REPLACE FUNCTION public.get_admin_users_stats(limit_offset integer DEFAULT 0, limit_count integer DEFAULT 20, search_query text DEFAULT NULL::text)
 RETURNS TABLE(user_id uuid, username text, display_name text, join_date timestamp with time zone, email character varying, provider text, vehicle_count bigint, status_counts jsonb, role user_role, banned boolean)
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public', 'auth'
AS $function$
BEGIN
  RETURN QUERY
  WITH vehicle_stats AS (
    SELECT
      owner_id,
      COUNT(*) as total,
      jsonb_object_agg(status, count) as status_details
    FROM (
      SELECT owner_id, COALESCE(current_status, 'unknown') as status, COUNT(*) as count
      FROM public.user_vehicle
      GROUP BY owner_id, current_status
    ) sub
    GROUP BY owner_id
  )
  SELECT
    up.user_id,
    up.username,
    up.display_name,
    au.created_at as join_date,
    au.email::varchar,
    (au.raw_app_meta_data->>'provider')::text as provider,
    COALESCE(vs.total, 0) as vehicle_count,
    COALESCE(vs.status_details, '{}'::jsonb) as status_counts,
    up.role,
    up.banned
  FROM public.user_profile up
  JOIN auth.users au ON up.user_id = au.id
  LEFT JOIN vehicle_stats vs ON up.user_id = vs.owner_id
  WHERE
    (search_query IS NULL OR 
     up.username ILIKE '%' || search_query || '%' OR 
     au.email ILIKE '%' || search_query || '%')
  ORDER BY au.created_at DESC
  LIMIT limit_count OFFSET limit_offset;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| get_dashboard_analytics             | user_id uuid                                                                                                                                                                                                                                                                                                                                                                                                                                        | CREATE OR REPLACE FUNCTION public.get_dashboard_analytics(user_id uuid)
 RETURNS TABLE(total_vehicles bigint, upcoming_tasks bigint, recent_event bigint, avg_days_between_services integer)
 LANGUAGE sql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
  WITH
    user_garages AS (
      SELECT garage_id
      FROM garage_member
      WHERE user_id = $1
    ),
    user_vehicles AS (
      SELECT id as vehicle_id
      FROM vehicle
      WHERE garage_id IN (SELECT garage_id FROM user_garages)
    ),
    vehicle_stats AS (
      SELECT
        COUNT(*) as total_vehicles,
        COUNT(DISTINCT CASE WHEN wi.status IN ('PLANNED', 'IN_PROGRESS') THEN wi.vehicle_id END) as vehicles_with_upcoming,
        COUNT(DISTINCT CASE WHEN e.created_at >= NOW() - INTERVAL '30 days' THEN e.vehicle_id END) as vehicles_with_recent_event
      FROM user_vehicles uv
      LEFT JOIN work_item wi ON wi.vehicle_id = uv.vehicle_id AND wi.status IN ('PLANNED', 'IN_PROGRESS')
      LEFT JOIN event e ON e.vehicle_id = uv.vehicle_id AND e.created_at >= NOW() - INTERVAL '30 days'
    ),
    upcoming_count AS (
      SELECT COUNT(*) as count
      FROM work_item wi
      JOIN user_vehicles uv ON wi.vehicle_id = uv.vehicle_id
      WHERE wi.status IN ('PLANNED', 'IN_PROGRESS')
    ),
    recent_event_count AS (
      SELECT COUNT(*) as count
      FROM event e
      JOIN user_vehicles uv ON e.vehicle_id = uv.vehicle_id
      WHERE e.created_at >= NOW() - INTERVAL '30 days'
    ),
    avg_service_interval AS (
      SELECT
        ROUND(AVG(interval_days)) as avg_days
      FROM (
        SELECT
          vehicle_id,
          EXTRACT(EPOCH FROM (created_at - LAG(created_at) OVER (PARTITION BY vehicle_id ORDER BY created_at DESC))) / 86400 as interval_days
        FROM event
        WHERE vehicle_id IN (SELECT vehicle_id FROM user_vehicles)
          AND type = 'SERVICE'
          AND created_at >= NOW() - INTERVAL '12 months'
      ) intervals
      WHERE interval_days IS NOT NULL
    )

  SELECT
    vs.total_vehicles,
    uc.count as upcoming_tasks,
    rec.count as recent_event,
    asi.avg_days as avg_days_between_services
  FROM vehicle_stats vs
  CROSS JOIN upcoming_count uc
  CROSS JOIN recent_event_count rec
  CROSS JOIN avg_service_interval asi;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| get_maintenance_due_vehicles        |                                                                                                                                                                                                                                                                                                                                                                                                                                                     | CREATE OR REPLACE FUNCTION public.get_maintenance_due_vehicles()
 RETURNS TABLE(user_id uuid, vehicle_id uuid, interval_id uuid, interval_name text, due_date timestamp with time zone, due_odometer integer)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
begin
  return query
  with latest_logs as (
    select distinct on (ml.user_vehicle_id, ml.service_interval_id)
      ml.user_vehicle_id,
      ml.service_interval_id,
      ml.event_date,
      ml.odometer
    from "Maintenance_Log" ml
    order by ml.user_vehicle_id, ml.service_interval_id, ml.event_date desc
  )
  select
    uv.owner_id as user_id,
    uv.id as vehicle_id,
    si.id as interval_id,
    si.name as interval_name,
    case
      when si.interval_months is not null then
        (coalesce(ll.event_date, uv.created_at) + (si.interval_months || ' months')::interval)
      else null
    end as due_date,
    case
      when si.interval_miles is not null then
        (coalesce(ll.odometer, 0) + si.interval_miles)
      else null
    end as due_odometer
  from "user_vehicle" uv
  join "Service_Intervals" si on true -- Cross join to check all intervals (or join on vehicle type if applicable)
  left join latest_logs ll on ll.user_vehicle_id = uv.id and ll.service_interval_id = si.id
  where
    -- Check Date-based due
    (
      si.interval_months is not null and
      now() >= (coalesce(ll.event_date, uv.created_at) + (si.interval_months || ' months')::interval)
    )
    OR
    -- Check Odometer-based due
    (
      si.interval_miles is not null and
      uv.odometer is not null and
      uv.odometer >= (coalesce(ll.odometer, 0) + si.interval_miles)
    );
end;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| get_my_vehicles                     |                                                                                                                                                                                                                                                                                                                                                                                                                                                     | CREATE OR REPLACE FUNCTION public.get_my_vehicles()
 RETURNS TABLE(id uuid, year integer, make text, model text, nickname text, created_at timestamp with time zone)
 LANGUAGE sql
 STABLE
 SET search_path TO 'public', 'pg_temp'
AS $function$
  select v.id, v.year, v.make, v.model, v.nickname, v.created_at
  from public.vehicle v
  where public.is_vehicle_owner(v.id);
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| get_unique_vehicles_with_trims      | limit_param integer DEFAULT 50, offset_param integer DEFAULT 0                                                                                                                                                                                                                                                                                                                                                                                      | CREATE OR REPLACE FUNCTION public.get_unique_vehicles_with_trims(limit_param integer DEFAULT 50, offset_param integer DEFAULT 0)
 RETURNS TABLE(id text, make text, model text, year text, hero_image text, trims jsonb)
 LANGUAGE plpgsql
 SET search_path TO 'public', 'extensions', 'pg_temp'
AS $function$
BEGIN
  RETURN QUERY
  SELECT
    CONCAT(vd.year, '-', vd.make, '-', vd.model) as id,
    vd.make,
    vd.model,
    vd.year,
    (array_agg(vd.image_url))[1] as hero_image,  -- Take first image as hero
    jsonb_agg(
      jsonb_build_object(
        'id', vd.id,
        'trim', vd."trim",
        'trim_description', vd.trim_description,
        'image_url', vd.image_url,
        'body_type', vd.body_type,
        'fuel_type', vd.fuel_type,
        'transmission', vd.transmission,
        'drive_type', vd.drive_type,
        'curb_weight_lbs', vd.curb_weight_lbs,
        'cylinders', vd.cylinders,
        'engine_size_l', vd.engine_size_l,
        'horsepower_hp', vd.horsepower_hp,
        'horsepower_rpm', vd.horsepower_rpm,
        'torque_ft_lbs', vd.torque_ft_lbs,
        'torque_rpm', vd.torque_rpm,
        'epa_combined_mpg', vd.epa_combined_mpg,
        'length_in', vd.length_in,
        'width_in', vd.width_in,
        'height_in', vd.height_in,
        'wheelbase_in', vd.wheelbase_in,
        'front_track_in', vd.front_track_in,
        'rear_track_in', vd.rear_track_in,
        'ground_clearance_in', vd.ground_clearance_in
      )
      ORDER BY vd."trim" ASC
    ) as trims
  FROM vehicle_data vd
  GROUP BY vd.year, vd.make, vd.model
  ORDER BY
    vd.year DESC,
    vd.make ASC,
    vd.model ASC
  LIMIT limit_param
  OFFSET offset_param;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| get_unique_vehicles_with_trims      | limit_param integer DEFAULT 50, offset_param integer DEFAULT 0, min_year_param integer DEFAULT NULL::integer, max_year_param integer DEFAULT NULL::integer, make_param text DEFAULT NULL::text, model_param text DEFAULT NULL::text, engine_type_param text DEFAULT NULL::text, fuel_type_param text DEFAULT NULL::text, drivetrain_param text DEFAULT NULL::text, vehicle_type_param text DEFAULT NULL::text, search_query text DEFAULT NULL::text | CREATE OR REPLACE FUNCTION public.get_unique_vehicles_with_trims(limit_param integer DEFAULT 50, offset_param integer DEFAULT 0, min_year_param integer DEFAULT NULL::integer, max_year_param integer DEFAULT NULL::integer, make_param text DEFAULT NULL::text, model_param text DEFAULT NULL::text, engine_type_param text DEFAULT NULL::text, fuel_type_param text DEFAULT NULL::text, drivetrain_param text DEFAULT NULL::text, vehicle_type_param text DEFAULT NULL::text, search_query text DEFAULT NULL::text)
 RETURNS TABLE(id text, make text, model text, year text, hero_image text, trims jsonb)
 LANGUAGE plpgsql
 STABLE SECURITY DEFINER
 SET search_path TO 'public', 'extensions', 'pg_temp'
AS $function$
BEGIN
  RETURN QUERY
  WITH visible_groups AS (
    SELECT vd.year, vd.make, vd.model
    FROM vehicle_data vd
    WHERE (min_year_param IS NULL OR vd.year::integer >= min_year_param)
      AND (max_year_param IS NULL OR vd.year::integer <= max_year_param)
      AND (make_param IS NULL OR vd.make = make_param)
      AND (model_param IS NULL OR vd.model = model_param)
      AND (engine_type_param IS NULL OR vd.cylinders = engine_type_param)
      AND (fuel_type_param IS NULL OR vd.fuel_type = fuel_type_param)
      AND (drivetrain_param IS NULL OR vd.drive_type = drivetrain_param)
      AND (vehicle_type_param IS NULL OR vd.body_type = vehicle_type_param)
      AND (
        search_query IS NULL 
        OR search_query = '' 
        OR (
           -- Multi-term search logic:
           -- Concatenate fields and check if the search query matches
           CONCAT_WS(' ', vd.year, vd.make, vd.model, vd.trim) ILIKE '%' || search_query || '%'
        )
      )
    GROUP BY vd.year, vd.make, vd.model
    ORDER BY vd.year DESC, vd.make ASC, vd.model ASC
    LIMIT limit_param OFFSET offset_param
  ),
  relevant_vehicles AS (
    SELECT vd.*
    FROM vehicle_data vd
    JOIN visible_groups vg ON vd.year = vg.year AND vd.make = vg.make AND vd.model = vg.model
  ),
  images AS (
    SELECT DISTINCT ON (vpi.vehicle_id) vpi.vehicle_id, vpi.url
    FROM vehicle_primary_image vpi
    JOIN relevant_vehicles rv ON vpi.vehicle_id = rv.id
    ORDER BY vpi.vehicle_id
  )
  SELECT
    CONCAT(rv.year, '-', rv.make, '-', rv.model) AS id,
    rv.make,
    rv.model,
    rv.year,
    COALESCE(MAX(i.url), '') AS hero_image,
    jsonb_agg(
      jsonb_build_object(
        'id', rv.id,
        'trim', rv."trim",
        'trim_description', rv.trim_description,
        'image_url', COALESCE(i.url, ''),
        'body_type', rv.body_type,
        'fuel_type', rv.fuel_type,
        'transmission', rv.transmission,
        'drive_type', rv.drive_type,
        'cylinders', rv.cylinders,
        'engine_size_l', rv.engine_size_l,
        'horsepower_hp', rv.horsepower_hp,
        'doors', rv.doors,
        'pros', rv.pros,
        'cons', rv.cons,
        'country_of_origin', rv.country_of_origin,
        'car_classification', rv.car_classification,
        'platform_code_generation', rv.platform_code_generation
      ) ORDER BY rv."trim" ASC
    ) AS trims
  FROM relevant_vehicles rv
  LEFT JOIN images i ON i.vehicle_id = rv.id
  GROUP BY rv.year, rv.make, rv.model
  ORDER BY rv.year DESC, rv.make ASC, rv.model ASC;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| get_user_vehicle_financials         |                                                                                                                                                                                                                                                                                                                                                                                                                                                     | CREATE OR REPLACE FUNCTION public.get_user_vehicle_financials()
 RETURNS TABLE(vehicle_id uuid, nickname text, odometer integer, total_spend numeric, mods_spend numeric, maintenance_spend numeric, cost_per_mile numeric)
 LANGUAGE plpgsql
 SET search_path TO 'public', 'extensions', 'pg_temp'
AS $function$
BEGIN
  RETURN QUERY
  SELECT
      uv.id AS vehicle_id,
      uv.nickname,
      uv.odometer,
      (COALESCE(mods.total_cost, 0) + COALESCE(maintenance.total_cost, 0)) AS total_spend,
      COALESCE(mods.total_cost, 0) AS mods_spend,
      COALESCE(maintenance.total_cost, 0) AS maintenance_spend,
      (COALESCE(mods.total_cost, 0) + COALESCE(maintenance.total_cost, 0)) / NULLIF(uv.odometer, 0) AS cost_per_mile
  FROM
      public.user_vehicle uv
  LEFT JOIN (
      SELECT user_vehicle_id, SUM(cost) AS total_cost
      FROM public.Mods
      GROUP BY user_vehicle_id
  ) AS mods ON uv.id = mods.user_vehicle_id
  LEFT JOIN (
    SELECT user_vehicle_id, SUM(cost) AS total_cost
    FROM public.Maintenance_Log
    GROUP BY user_vehicle_id
  ) AS maintenance ON uv.id = maintenance.user_vehicle_id
  WHERE
      uv.owner_id = auth.uid();
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| get_vehicle_analytics               | vehicle_ids uuid[], thirty_days_ago timestamp with time zone                                                                                                                                                                                                                                                                                                                                                                                        | CREATE OR REPLACE FUNCTION public.get_vehicle_analytics(vehicle_ids uuid[], thirty_days_ago timestamp with time zone)
 RETURNS TABLE(vehicle_id uuid, upcoming_tasks bigint, last_service_date timestamp with time zone, event_30_days bigint, days_since_last_service integer, avg_days_between_services integer, last_event_date timestamp with time zone)
 LANGUAGE sql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
  WITH
    -- Upcoming tasks (PLANNED + IN_PROGRESS)
    upcoming_tasks AS (
      SELECT
        vehicle_id,
        COUNT(*) as count
      FROM work_item
      WHERE vehicle_id = ANY(vehicle_ids)
        AND status IN ('PLANNED', 'IN_PROGRESS')
      GROUP BY vehicle_id
    ),

    -- Service event with ranking for last service
    service_event AS (
      SELECT
        vehicle_id,
        created_at,
        ROW_NUMBER() OVER (PARTITION BY vehicle_id ORDER BY created_at DESC) as rn,
        LAG(created_at) OVER (PARTITION BY vehicle_id ORDER BY created_at DESC) as prev_service_date
      FROM event
      WHERE vehicle_id = ANY(vehicle_ids)
        AND type = 'SERVICE'
    ),

    -- Last service per vehicle
    last_services AS (
      SELECT
        vehicle_id,
        created_at as last_service_date,
        prev_service_date
      FROM service_event
      WHERE rn = 1
    ),

    -- event in last 30 days
    recent_event AS (
      SELECT
        vehicle_id,
        COUNT(*) as count
      FROM event
      WHERE vehicle_id = ANY(vehicle_ids)
        AND created_at >= thirty_days_ago
      GROUP BY vehicle_id
    ),

    -- Last event of any type per vehicle
    last_any_event AS (
      SELECT
        vehicle_id,
        created_at as last_event_date
      FROM (
        SELECT
          vehicle_id,
          created_at,
          ROW_NUMBER() OVER (PARTITION BY vehicle_id ORDER BY created_at DESC) as rn
        FROM event
        WHERE vehicle_id = ANY(vehicle_ids)
      ) ranked
      WHERE rn = 1
    ),

    -- Average days between services (last 12 months)
    service_intervals AS (
      SELECT
        vehicle_id,
        ROUND(AVG(interval_days)) as avg_days
      FROM (
        SELECT
          vehicle_id,
          EXTRACT(EPOCH FROM (created_at - LAG(created_at) OVER (PARTITION BY vehicle_id ORDER BY created_at DESC))) / 86400 as interval_days
        FROM event
        WHERE vehicle_id = ANY(vehicle_ids)
          AND type = 'SERVICE'
          AND created_at >= NOW() - INTERVAL '12 months'
      ) intervals
      WHERE interval_days IS NOT NULL
      GROUP BY vehicle_id
      HAVING COUNT(*) >= 2
    )

  SELECT
    COALESCE(ut.vehicle_id, ls.vehicle_id, re.vehicle_id, lae.vehicle_id, si.vehicle_id) as vehicle_id,
    COALESCE(ut.count, 0) as upcoming_tasks,
    ls.last_service_date,
    COALESCE(re.count, 0) as event_30_days,
    CASE
      WHEN ls.last_service_date IS NOT NULL THEN
        GREATEST(0, EXTRACT(EPOCH FROM (NOW() - ls.last_service_date)) / 86400)::INTEGER
      ELSE NULL
    END as days_since_last_service,
    si.avg_days as avg_days_between_services,
    lae.last_event_date
  FROM upcoming_tasks ut
  FULL OUTER JOIN last_services ls ON ut.vehicle_id = ls.vehicle_id
  FULL OUTER JOIN recent_event re ON COALESCE(ut.vehicle_id, ls.vehicle_id) = re.vehicle_id
  FULL OUTER JOIN last_any_event lae ON COALESCE(ut.vehicle_id, ls.vehicle_id, re.vehicle_id) = lae.vehicle_id
  FULL OUTER JOIN service_intervals si ON COALESCE(ut.vehicle_id, ls.vehicle_id, re.vehicle_id, lae.vehicle_id) = si.vehicle_id
  WHERE COALESCE(ut.vehicle_id, ls.vehicle_id, re.vehicle_id, lae.vehicle_id, si.vehicle_id) = ANY(vehicle_ids);
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| get_vehicle_build_thread            | vehicle_id_param uuid                                                                                                                                                                                                                                                                                                                                                                                                                               | CREATE OR REPLACE FUNCTION public.get_vehicle_build_thread(vehicle_id_param uuid)
 RETURNS TABLE(event_id uuid, event_title text, description text, event_date timestamp with time zone, event_type text, status text)
 LANGUAGE plpgsql
 SET search_path TO 'public', 'extensions', 'pg_temp'
AS $function$
BEGIN
  RETURN QUERY
  (
      SELECT
          m.id AS event_id,
          m.title AS event_title,
          m.description,
          m.event_date,
          'Modification' AS event_type,
          m.status
      FROM
          public.Mods m
      WHERE
          m.user_vehicle_id = vehicle_id_param
  )
  UNION ALL
  (
      SELECT
          ml.id AS event_id,
          ml.description AS event_title,
          '' AS description, -- No separate description field in maintenance log
          ml.event_date,
          'Maintenance' AS event_type,
          'completed' AS status -- Maintenance is always a completed event
      FROM
          public.Maintenance_Log ml
      WHERE
          ml.user_vehicle_id = vehicle_id_param
  )
  ORDER BY
      event_date DESC;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| get_vehicle_filter_options          |                                                                                                                                                                                                                                                                                                                                                                                                                                                     | CREATE OR REPLACE FUNCTION public.get_vehicle_filter_options()
 RETURNS json
 LANGUAGE sql
 STABLE SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
  SELECT options FROM public.mv_vehicle_filter_options LIMIT 1;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| get_vehicle_makes                   | year_filter text DEFAULT NULL::text                                                                                                                                                                                                                                                                                                                                                                                                                 | CREATE OR REPLACE FUNCTION public.get_vehicle_makes(year_filter text DEFAULT NULL::text)
 RETURNS TABLE(make_value text)
 LANGUAGE sql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
  SELECT DISTINCT make as make_value
  FROM vehicle_data
  WHERE make IS NOT NULL
    AND LENGTH(TRIM(make)) > 0
    AND (year_filter IS NULL OR year::TEXT = year_filter)
  ORDER BY make_value;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| get_vehicle_models                  | make_filter text, year_filter text DEFAULT NULL::text                                                                                                                                                                                                                                                                                                                                                                                               | CREATE OR REPLACE FUNCTION public.get_vehicle_models(make_filter text, year_filter text DEFAULT NULL::text)
 RETURNS TABLE(model_value text)
 LANGUAGE sql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
  SELECT DISTINCT model as model_value
  FROM vehicle_data
  WHERE model IS NOT NULL
    AND LENGTH(TRIM(model)) > 0
    AND make = make_filter
    AND (year_filter IS NULL OR year::TEXT = year_filter)
  ORDER BY model_value;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| get_vehicle_trims                   | make_filter text, model_filter text, year_filter text DEFAULT NULL::text                                                                                                                                                                                                                                                                                                                                                                            | CREATE OR REPLACE FUNCTION public.get_vehicle_trims(make_filter text, model_filter text, year_filter text DEFAULT NULL::text)
 RETURNS TABLE(trim_value text)
 LANGUAGE sql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
  SELECT DISTINCT trim as trim_value
  FROM vehicle_data
  WHERE trim IS NOT NULL
    AND LENGTH(TRIM(trim)) > 0
    AND make = make_filter
    AND model = model_filter
    AND (year_filter IS NULL OR year::TEXT = year_filter)
  ORDER BY trim_value;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| get_vehicle_years                   |                                                                                                                                                                                                                                                                                                                                                                                                                                                     | CREATE OR REPLACE FUNCTION public.get_vehicle_years()
 RETURNS TABLE(year_value text)
 LANGUAGE sql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
  SELECT DISTINCT year::TEXT as year_value
  FROM vehicle_data
  WHERE year IS NOT NULL
    AND year >= 1900
    AND year <= EXTRACT(YEAR FROM NOW()) + 1
  ORDER BY year_value DESC;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| is_user_banned                      | user_uuid uuid                                                                                                                                                                                                                                                                                                                                                                                                                                      | CREATE OR REPLACE FUNCTION public.is_user_banned(user_uuid uuid)
 RETURNS boolean
 LANGUAGE sql
 SECURITY DEFINER
 SET search_path TO 'public', 'extensions', 'pg_temp'
AS $function$
  select coalesce(banned, false) from public.user_profile where user_id = user_uuid;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| is_vehicle_member                   | v_id uuid                                                                                                                                                                                                                                                                                                                                                                                                                                           | CREATE OR REPLACE FUNCTION public.is_vehicle_member(v_id uuid)
 RETURNS boolean
 LANGUAGE sql
 STABLE
 SET search_path TO 'public', 'pg_temp'
AS $function$
  select exists (
    select 1
    from vehicle v
    join garage g on g.id = v.garage_id
    where v.id = v_id
      and (
        g.owner_id = auth.uid()
        or exists (
          select 1 from garage_member gm
          where gm.garage_id = g.id and gm.user_id = auth.uid()
        )
      )
  );
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| is_vehicle_owner                    | _vehicle_id uuid                                                                                                                                                                                                                                                                                                                                                                                                                                    | CREATE OR REPLACE FUNCTION public.is_vehicle_owner(_vehicle_id uuid)
 RETURNS boolean
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
declare
  _uid uuid := auth.uid();
  _ok  boolean;
begin
  select true into _ok
  from public.vehicle v
  join public.garage g on g.id = v.garage_id
  where v.id = _vehicle_id
    and g.owner_id = _uid
  limit 1;

  return coalesce(_ok, false);
end
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| log_activity                        | p_entity text, p_id uuid, p_diff jsonb                                                                                                                                                                                                                                                                                                                                                                                                              | CREATE OR REPLACE FUNCTION public.log_activity(p_entity text, p_id uuid, p_diff jsonb)
 RETURNS void
 LANGUAGE sql
 SECURITY DEFINER
 SET search_path TO 'public', 'pg_temp'
AS $function$
  insert into public.activity_log(entity_type, entity_id, user_id, diff)
  values (p_entity, p_id, auth.uid(), coalesce(p_diff, '{}'::jsonb));
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| log_user_profile_activity           |                                                                                                                                                                                                                                                                                                                                                                                                                                                     | CREATE OR REPLACE FUNCTION public.log_user_profile_activity()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public', 'extensions', 'pg_temp'
AS $function$
DECLARE
  old_role_text text;
  new_role_text text;
BEGIN
  -- Convert enum to text for comparison and storage
  old_role_text := CASE 
    WHEN OLD.role IS NULL THEN NULL::text
    ELSE OLD.role::text
  END;
  
  new_role_text := CASE 
    WHEN NEW.role IS NULL THEN NULL::text
    ELSE NEW.role::text
  END;

  -- Only log if role actually changed
  IF OLD.role IS DISTINCT FROM NEW.role THEN
    INSERT INTO public.activity_log (
      user_id,
      action,
      entity_type,
      entity_id,
      old_data,
      new_data,
      diff,
      created_at
    ) VALUES (
      NEW.user_id, -- UUID
      'update', -- text
      'user_profile', -- text
      NEW.user_id::text, -- Convert UUID to text for entity_id
      jsonb_build_object('role', old_role_text),
      jsonb_build_object('role', new_role_text),
      jsonb_build_object('role', jsonb_build_object('old', old_role_text, 'new', new_role_text)),
      now()
    );
  END IF;

  RETURN NEW;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| notify_parts_mv_refresh             |                                                                                                                                                                                                                                                                                                                                                                                                                                                     | CREATE OR REPLACE FUNCTION public.notify_parts_mv_refresh()
 RETURNS trigger
 LANGUAGE plpgsql
 SET search_path TO 'public', 'pg_temp'
AS $function$
begin
  perform refresh_vehicle_parts_current();
  return null;
end $function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| odometer_at                         | p_user_vehicle_id uuid, p_ts timestamp with time zone                                                                                                                                                                                                                                                                                                                                                                                               | CREATE OR REPLACE FUNCTION public.odometer_at(p_user_vehicle_id uuid, p_ts timestamp with time zone)
 RETURNS integer
 LANGUAGE sql
 STABLE
 SET search_path TO 'public', 'extensions', 'pg_temp'
AS $function$
  select reading_mi
  from public.odometer_log
  where user_vehicle_id = p_user_vehicle_id
    and recorded_at <= p_ts
  order by recorded_at desc
  limit 1
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| plan_creator_for_vehicle            | p_vehicle uuid                                                                                                                                                                                                                                                                                                                                                                                                                                      | CREATE OR REPLACE FUNCTION public.plan_creator_for_vehicle(p_vehicle uuid)
 RETURNS uuid
 LANGUAGE sql
 STABLE
 SET search_path TO 'public', 'extensions', 'pg_temp'
AS $function$
  select coalesce(g.owner_id, (select system_user_id from public.app_settings limit 1))
  from public.vehicle v
  join public.garage g on g.id = v.garage_id
  where v.id = p_vehicle
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| prevent_admin_self_demotion         |                                                                                                                                                                                                                                                                                                                                                                                                                                                     | CREATE OR REPLACE FUNCTION public.prevent_admin_self_demotion()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public', 'extensions', 'pg_temp'
AS $function$
begin
  -- If user is trying to change their own role and they are an admin
  if old.role = 'admin' and
     current_setting('request.jwt.claims', true)::json->>'sub' = old.user_id::text and
     new.role != 'admin' then
    raise exception 'Admins cannot demote themselves. Contact another admin to change your role.';
  end if;

  return new;
end;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| prevent_event_update_after_24h      |                                                                                                                                                                                                                                                                                                                                                                                                                                                     | CREATE OR REPLACE FUNCTION public.prevent_event_update_after_24h()
 RETURNS trigger
 LANGUAGE plpgsql
 SET search_path TO 'public', 'pg_temp'
AS $function$
begin
  if (now() - old.created_at > interval '24 hours') then
    raise exception 'Events are immutable after 24h; create a correction event instead';
  end if;
  return new;
end $function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| recommend_vehicles                  | prefs jsonb, weights jsonb DEFAULT '{}'::jsonb, limit_n integer DEFAULT 12                                                                                                                                                                                                                                                                                                                                                                          | CREATE OR REPLACE FUNCTION public.recommend_vehicles(prefs jsonb, weights jsonb DEFAULT '{}'::jsonb, limit_n integer DEFAULT 12)
 RETURNS TABLE(vehicle_id bigint, score numeric, reasons jsonb)
 LANGUAGE sql
 STABLE
 SET search_path TO 'public', 'pg_temp'
AS $function$
with params as (
  select
    (prefs->>'min_hp')::int                    as min_hp,
    (prefs->>'drivetrain')::text               as pref_drive,
    (prefs->>'body_style')::text               as pref_body,
    (prefs->>'seats_min')::int                 as seats_min,
    (prefs->>'doors_min')::int                 as doors_min,
    (prefs->>'doors_eq')::int                  as doors_eq,
    (prefs->>'pref_country')::text             as pref_country,
    (prefs->>'pref_region')::text              as pref_region,  -- e.g. 'europe'
    (prefs->>'cylinders_min')::int             as cylinders_min,
    (prefs->>'text_query')::text               as q,
    (prefs->>'target_embed')::text             as target_embed_base64,
    coalesce((prefs->>'exclude_truck')::boolean,false) as ex_truck,
    coalesce((prefs->>'exclude_van')::boolean,  false) as ex_van,
    coalesce((prefs->>'exclude_suv')::boolean,  false) as ex_suv
),
base as (
  select
    vd.id::bigint                                   as vehicle_id,
    vd.make, vd.model,
    coalesce(vd.new_year, vd.year)::int             as year,
    lower(coalesce(vd.body_type,''))                as body_norm,
    lower(coalesce(vd.drive_type,''))               as drive_norm,
    vd.horsepower_hp                                as hp,
    vd.total_seating                                as seats,
    nullif(regexp_replace(coalesce(vd.doors,''), '\D', '', 'g'), '')::int as doors,
    nullif(regexp_replace(coalesce(vd.cylinders,''), '\D', '', 'g'), '')::int as cyl_num,
    lower(coalesce(vd.country_of_origin,''))        as country_norm,
    setweight(to_tsvector('simple', coalesce(vd.make,'') || ' ' || coalesce(vd.model,'')),'A') ||
    setweight(to_tsvector('simple', coalesce(vd.trim,'')),'B') ||
    setweight(to_tsvector('simple', coalesce(vd.body_type,'')),'C') ||
    setweight(to_tsvector('simple', coalesce(vd.drive_type,'')),'C') as search_doc
  from public.vehicle_data vd
),
filtered as (
  select
    b.*,
    -- body style soft match
    (params.pref_body is null or b.body_norm ilike ('%'||lower(params.pref_body)||'%')) as body_match,
    -- drivetrain STRICT mapping
    case
      when params.pref_drive is null then true
      when params.pref_drive ilike 'AWD'
        then (b.drive_norm like '%all wheel%' or b.drive_norm like '%awd%')
      when params.pref_drive ilike '4WD'
        then (b.drive_norm like '%four wheel%' or b.drive_norm like '%4wd%')
      when params.pref_drive ilike 'FWD'
        then (b.drive_norm like '%front wheel%' or b.drive_norm like '%fwd%')
      when params.pref_drive ilike 'RWD'
        then (b.drive_norm like '%rear wheel%' or b.drive_norm like '%rwd%')
      else b.drive_norm ilike ('%'||lower(params.pref_drive)||'%')
    end as drive_match
  from base b
  cross join params
)
select
  f.vehicle_id,
  -- simple, deterministic score (no price, no vectors yet)
  (
    (case when f.drive_match then 0.70 else 0 end) +
    (case when f.body_match  then 0.20 else 0 end) +
    (case when params.min_hp is not null and f.hp >= params.min_hp then 0.10 else 0 end)
  )::numeric as score,
  jsonb_build_object(
    'drive_match', f.drive_match,
    'body_match',  f.body_match,
    'cyl_ok',      (params.cylinders_min is null or f.cyl_num >= params.cylinders_min),
    'origin_ok',   case
                     when params.pref_country is not null
                       then (f.country_norm like ('%'||lower(params.pref_country)||'%'))
                     when coalesce(params.pref_region,'') ilike 'europe'
                       then (f.country_norm like any (array[
                         '%germany%','%austria%','%switzerland%','%france%','%italy%','%spain%','%portugal%',
                         '%united kingdom%','%uk%','%england%','%wales%','%scotland%','%ireland%',
                         '%netherlands%','%holland%','%belgium%','%luxembourg%',
                         '%sweden%','%norway%','%denmark%','%finland%',
                         '%poland%','%czech%','%slovak%','%hungary%','%romania%','%bulgaria%',
                         '%slovenia%','%croatia%','%serbia%','%bosnia%','%albania%','%greece%'
                       ]))
                     else true
                   end
  ) as reasons
from filtered f
cross join params
where
  (params.min_hp     is null or f.hp    >= params.min_hp)
  and (params.seats_min is null or f.seats >= params.seats_min)
  and (params.doors_eq  is null or f.doors =  params.doors_eq)
  and (params.doors_min is null or f.doors >= params.doors_min)
  and (params.cylinders_min is null or f.cyl_num >= params.cylinders_min)
  and (params.ex_truck = false or (f.body_norm not ilike '%truck%' and f.body_norm not ilike '%pickup%'))
  and (params.ex_van   = false or f.body_norm not ilike '%van%')
  and (params.ex_suv   = false or (f.body_norm not ilike '%suv%' and f.body_norm not ilike '%crossover%' and f.body_norm not ilike '%sport utility%'))
  and f.body_match
  and f.drive_match
  -- country/region filter (same logic as reasons.origin_ok)
  and (
    params.pref_country is null
    or f.country_norm like ('%'||lower(params.pref_country)||'%')
  )
  and (
    coalesce(params.pref_region,'') not ilike 'europe'
    or f.country_norm like any (array[
      '%germany%','%austria%','%switzerland%','%france%','%italy%','%spain%','%portugal%',
      '%united kingdom%','%uk%','%england%','%wales%','%scotland%','%ireland%',
      '%netherlands%','%holland%','%belgium%','%luxembourg%',
      '%sweden%','%norway%','%denmark%','%finland%',
      '%poland%','%czech%','%slovak%','%hungary%','%romania%','%bulgaria%',
      '%slovenia%','%croatia%','%serbia%','%bosnia%','%albania%','%greece%'
    ])
  )
order by score desc
limit limit_n;
$function$
 |
| refresh_vehicle_parts_current       |                                                                                                                                                                                                                                                                                                                                                                                                                                                     | CREATE OR REPLACE FUNCTION public.refresh_vehicle_parts_current()
 RETURNS void
 LANGUAGE sql
 SET search_path TO 'public', 'pg_temp'
AS $function$
  refresh materialized view concurrently vehicle_parts_current;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| set_updated_at                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                     | CREATE OR REPLACE FUNCTION public.set_updated_at()
 RETURNS trigger
 LANGUAGE plpgsql
 SET search_path TO 'public', 'extensions', 'pg_temp'
AS $function$
begin
  new.updated_at = now();
  return new;
end;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| stamp_build_plan_status_dates       |                                                                                                                                                                                                                                                                                                                                                                                                                                                     | CREATE OR REPLACE FUNCTION public.stamp_build_plan_status_dates()
 RETURNS trigger
 LANGUAGE plpgsql
 SET search_path TO 'public', 'pg_temp'
AS $function$
begin
  if new.status <> old.status then
    if new.status = 'closed' and old.status <> 'closed' then
      new.closed_at := now();
    end if;
    if new.status = 'archived' and old.status <> 'archived' then
      new.archived_at := now();
    end if;
  end if;
  return new;
end $function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| tg_build_plan_status_event          |                                                                                                                                                                                                                                                                                                                                                                                                                                                     | CREATE OR REPLACE FUNCTION public.tg_build_plan_status_event()
 RETURNS trigger
 LANGUAGE plpgsql
 SET search_path TO 'public', 'pg_temp'
AS $function$
declare
  v_vehicle_id uuid;
begin
  if new.status is distinct from old.status then
    select vehicle_id into v_vehicle_id from public.build_plans where id = new.id;

    perform public.emit_event(
      'build',
      v_vehicle_id,
      format('Build plan "%s" status: %s  %s', coalesce(new.name,'(unnamed)'), old.status, new.status),
      jsonb_build_object(
        'build_plan_id', new.id,
        'name', new.name,
        'status_old', old.status,
        'status_new', new.status
      ),
      new.id
    );
  end if;
  return new;
end
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| tg_garage_owner_member              |                                                                                                                                                                                                                                                                                                                                                                                                                                                     | CREATE OR REPLACE FUNCTION public.tg_garage_owner_member()
 RETURNS trigger
 LANGUAGE plpgsql
 SET search_path TO 'public', 'extensions', 'pg_temp'
AS $function$
begin
  insert into public.garage_member (garage_id, user_id, role)
  values (new.id, new.owner_id, 'owner')
  on conflict (garage_id, user_id) do update set role = 'owner';
  return new;
end$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| tg_job_created_event                |                                                                                                                                                                                                                                                                                                                                                                                                                                                     | CREATE OR REPLACE FUNCTION public.tg_job_created_event()
 RETURNS trigger
 LANGUAGE plpgsql
 SET search_path TO 'public', 'pg_temp'
AS $function$
declare
  v_vehicle_id uuid;
begin
  select bp.vehicle_id into v_vehicle_id from public.build_plans bp where bp.id = new.build_plan_id;

  perform public.emit_event(
    'build',
    v_vehicle_id,
    format('Job created: %s', coalesce(new.title,'(untitled)')),
    jsonb_build_object(
      'job_id', new.id,
      'build_plan_id', new.build_plan_id,
      'title', new.title,
      'status', new.status
    ),
    new.build_plan_id
  );

  return new;
end
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| tg_job_part_added_event             |                                                                                                                                                                                                                                                                                                                                                                                                                                                     | CREATE OR REPLACE FUNCTION public.tg_job_part_added_event()
 RETURNS trigger
 LANGUAGE plpgsql
 SET search_path TO 'public', 'pg_temp'
AS $function$
declare
  v_bp uuid;
  v_vehicle_id uuid;
begin
  select j.build_plan_id into v_bp from public.job j where j.id = new.job_id;
  select bp.vehicle_id into v_vehicle_id from public.build_plans bp where bp.id = v_bp;

  perform public.emit_event(
    'build',
    v_vehicle_id,
    format('Part added%s%s',
      case when new.name is not null then ': ' else '' end,
      coalesce(new.name, '')
    ),
    jsonb_build_object(
      'part_id', new.id,
      'job_id', new.job_id,
      'build_plan_id', v_bp,
      'name', new.name,
      'brand', new.brand,
      'part_number', new.part_number,
      'price', new.price,
      'qty', new.qty,
      'affiliate_url', new.affiliate_url
    ),
    v_bp
  );

  return new;
end
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| tg_job_part_updated_event           |                                                                                                                                                                                                                                                                                                                                                                                                                                                     | CREATE OR REPLACE FUNCTION public.tg_job_part_updated_event()
 RETURNS trigger
 LANGUAGE plpgsql
 SET search_path TO 'public', 'pg_temp'
AS $function$
declare
  v_bp uuid;
  v_vehicle_id uuid;
begin
  if (new.price is distinct from old.price)
     or (new.qty is distinct from old.qty)
     or (new.affiliate_url is distinct from old.affiliate_url)
     or (new.name is distinct from old.name)
     or (new.brand is distinct from old.brand)
     or (new.part_number is distinct from old.part_number) then

    select j.build_plan_id into v_bp from public.job j where j.id = new.job_id;
    select bp.vehicle_id into v_vehicle_id from public.build_plans bp where bp.id = v_bp;

    perform public.emit_event(
      'build',
      v_vehicle_id,
      'Part updated',
      jsonb_build_object(
        'part_id', new.id,
        'job_id', new.job_id,
        'build_plan_id', v_bp,
        'diff', jsonb_build_object(
          'price_old', old.price, 'price_new', new.price,
          'qty_old', old.qty, 'qty_new', new.qty,
          'affiliate_url_old', old.affiliate_url, 'affiliate_url_new', new.affiliate_url,
          'name_old', old.name, 'name_new', new.name,
          'brand_old', old.brand, 'brand_new', new.brand,
          'part_number_old', old.part_number, 'part_number_new', new.part_number
        )
      ),
      v_bp
    );
  end if;

  return new;
end
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| tg_job_status_changed_event         |                                                                                                                                                                                                                                                                                                                                                                                                                                                     | CREATE OR REPLACE FUNCTION public.tg_job_status_changed_event()
 RETURNS trigger
 LANGUAGE plpgsql
 SET search_path TO 'public', 'pg_temp'
AS $function$
declare
  v_vehicle_id uuid;
begin
  if new.status is distinct from old.status then
    select bp.vehicle_id into v_vehicle_id from public.build_plans bp where bp.id = new.build_plan_id;

    perform public.emit_event(
      'build',
      v_vehicle_id,
      format('Job status: %s  %s', old.status, new.status),
      jsonb_build_object(
        'job_id', new.id,
        'build_plan_id', new.build_plan_id,
        'title', new.title,
        'status_old', old.status,
        'status_new', new.status
      ),
      new.build_plan_id
    );
  end if;
  return new;
end
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| tg_job_task_added_event             |                                                                                                                                                                                                                                                                                                                                                                                                                                                     | CREATE OR REPLACE FUNCTION public.tg_job_task_added_event()
 RETURNS trigger
 LANGUAGE plpgsql
 SET search_path TO 'public', 'pg_temp'
AS $function$
declare
  v_bp uuid;
  v_vehicle_id uuid;
begin
  select j.build_plan_id into v_bp from public.job j where j.id = new.job_id;
  select bp.vehicle_id into v_vehicle_id from public.build_plans bp where bp.id = v_bp;

  perform public.emit_event(
    'build',
    v_vehicle_id,
    format('Task added: %s', coalesce(new.title,'(untitled)')),
    jsonb_build_object(
      'task_id', new.id,
      'job_id', new.job_id,
      'build_plan_id', v_bp,
      'status', new.status
    ),
    v_bp
  );

  return new;
end
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| tg_job_task_status_changed_event    |                                                                                                                                                                                                                                                                                                                                                                                                                                                     | CREATE OR REPLACE FUNCTION public.tg_job_task_status_changed_event()
 RETURNS trigger
 LANGUAGE plpgsql
 SET search_path TO 'public', 'pg_temp'
AS $function$
declare
  v_bp uuid;
  v_vehicle_id uuid;
begin
  if new.status is distinct from old.status then
    select j.build_plan_id into v_bp from public.job j where j.id = new.job_id;
    select bp.vehicle_id into v_vehicle_id from public.build_plans bp where bp.id = v_bp;

    perform public.emit_event(
      'build',
      v_vehicle_id,
      format('Task status: %s  %s', old.status, new.status),
      jsonb_build_object(
        'task_id', new.id,
        'job_id', new.job_id,
        'build_plan_id', v_bp,
        'status_old', old.status,
        'status_new', new.status
      ),
      v_bp
    );
  end if;

  return new;
end
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| tg_log_insert                       |                                                                                                                                                                                                                                                                                                                                                                                                                                                     | CREATE OR REPLACE FUNCTION public.tg_log_insert()
 RETURNS trigger
 LANGUAGE plpgsql
 SET search_path TO 'public', 'pg_temp'
AS $function$
begin
  -- Prevent recursion: do not log inserts to the activity_log table itself
  if tg_table_name = 'activity_log' then
    return new;
  end if;
  
  perform public.log_activity(tg_table_name, new.id, to_jsonb(new));
  return new;
end $function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| tg_log_update                       |                                                                                                                                                                                                                                                                                                                                                                                                                                                     | CREATE OR REPLACE FUNCTION public.tg_log_update()
 RETURNS trigger
 LANGUAGE plpgsql
 SET search_path TO 'public', 'pg_temp'
AS $function$
begin
  -- Prevent recursion: do not log updates to the activity_log table itself
  if tg_table_name = 'activity_log' then
    return new;
  end if;
  perform public.log_activity(tg_table_name, new.id, jsonb_build_object('old', to_jsonb(old), 'new', to_jsonb(new)));
  return new;
end $function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| touch_updated_at                    |                                                                                                                                                                                                                                                                                                                                                                                                                                                     | CREATE OR REPLACE FUNCTION public.touch_updated_at()
 RETURNS trigger
 LANGUAGE plpgsql
 SET search_path TO 'public', 'pg_temp'
AS $function$
begin
  new.updated_at := now();
  return new;
end $function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| trg_task_done_upsert_part_and_event |                                                                                                                                                                                                                                                                                                                                                                                                                                                     | CREATE OR REPLACE FUNCTION public.trg_task_done_upsert_part_and_event()
 RETURNS trigger
 LANGUAGE plpgsql
 SET search_path TO 'public', 'pg_temp'
AS $function$
declare
  _part_state_id uuid;
  _event_id uuid;
begin
  if (new.status = 'done' and (old.status is distinct from 'done')) then
    if new.slot_code is not null and new.part_variant_id is not null then
      update public.vehicle_part_state
         set valid_to = coalesce(new.completed_at, now())
       where vehicle_id = new.vehicle_id
         and slot_code  = new.slot_code
         and valid_to is null;

      insert into public.vehicle_part_state (
        vehicle_id, slot_code, slot_label,
        catalog_id, variant_id, source,
        valid_from, created_by
      )
      select
        new.vehicle_id,
        new.slot_code,
        initcap(replace(new.slot_code,'_',' ')),
        v.catalog_id,
        v.id,
        'task',
        coalesce(new.completed_at, now()),
        new.created_by
      from public.part_variants v
      where v.id = new.part_variant_id
      returning id into _part_state_id;

      insert into public.events (
        vehicle_id, type, title,
        occurred_on, date_confidence, payload, created_by
      )
      values (
        new.vehicle_id,
        'task_completed',
        new.title,
        new.completed_at::date,
        (case when new.completed_at is null
              then 'unknown'::public.date_confidence
              else 'exact'::public.date_confidence end),
        jsonb_build_object('slot_code', new.slot_code, 'part_variant_id', new.part_variant_id),
        new.created_by
      )
      returning id into _event_id;

      insert into public.event_entities(event_id, work_item_id, part_state_id)
      values (_event_id, new.id, _part_state_id);

    else
      insert into public.events (vehicle_id, type, title, occurred_on, date_confidence, created_by)
      values (
        new.vehicle_id, 'task_completed', new.title,
        new.completed_at::date,
        (case when new.completed_at is null
              then 'unknown'::public.date_confidence
              else 'exact'::public.date_confidence end),
        new.created_by
      )
      returning id into _event_id;

      insert into public.event_entities(event_id, work_item_id)
      values (_event_id, new.id);
    end if;
  end if;
  return new;
end
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| update_user_role                    | p_user_id uuid, p_role text                                                                                                                                                                                                                                                                                                                                                                                                                         | CREATE OR REPLACE FUNCTION public.update_user_role(p_user_id uuid, p_role text)
 RETURNS jsonb
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
  v_old_role user_role;
  v_new_role user_role;
  v_result jsonb;
BEGIN
  -- Validate the role value
  IF p_role NOT IN ('user', 'helper', 'admin') THEN
    RETURN jsonb_build_object(
      'success', false,
      'error', 'Invalid role value. Must be user, helper, or admin',
      'error_code', 'INVALID_ROLE'
    );
  END IF;
  
  -- Get current role
  SELECT role INTO v_old_role
  FROM public.user_profile
  WHERE user_id = p_user_id;
  
  IF NOT FOUND THEN
    RETURN jsonb_build_object(
      'success', false,
      'error', 'User not found',
      'error_code', 'USER_NOT_FOUND'
    );
  END IF;
  
  -- Cast to enum
  v_new_role := p_role::user_role;
  
  -- Update the role (this will trigger the activity log trigger)
  UPDATE public.user_profile
  SET role = v_new_role
  WHERE user_id = p_user_id;
  
  -- Return success with details
  RETURN jsonb_build_object(
    'success', true,
    'user_id', p_user_id,
    'old_role', v_old_role::text,
    'new_role', v_new_role::text
  );
  
EXCEPTION
  WHEN invalid_text_representation THEN
    RETURN jsonb_build_object(
      'success', false,
      'error', 'Invalid role enum value: ' || p_role,
      'error_code', 'INVALID_ENUM'
    );
  WHEN OTHERS THEN
    RETURN jsonb_build_object(
      'success', false,
      'error', SQLERRM,
      'error_code', SQLSTATE,
      'detail', SQLERRM
    );
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| upsert_event_for_diy_job            |                                                                                                                                                                                                                                                                                                                                                                                                                                                     | CREATE OR REPLACE FUNCTION public.upsert_event_for_diy_job()
 RETURNS trigger
 LANGUAGE plpgsql
 SET search_path TO 'public', 'pg_temp'
AS $function$
begin
  if new.status = 'done' and new.completed_at is not null then
    insert into public.events(
      vehicle_id, type, title, occurred_on, date_confidence, payload, created_by
    )
    values (
      new.vehicle_id,
      'INSTALL',
      new.title,
      new.completed_at::date,
      'exact',
      jsonb_build_object('diy_job_id', new.id),
      new.created_by
    )
    on conflict do nothing;
  end if;
  return new;
end; $function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| upsert_event_for_service            |                                                                                                                                                                                                                                                                                                                                                                                                                                                     | CREATE OR REPLACE FUNCTION public.upsert_event_for_service()
 RETURNS trigger
 LANGUAGE plpgsql
 SET search_path TO 'public', 'pg_temp'
AS $function$
begin
  insert into public.events(
    vehicle_id, type, title, occurred_on, date_confidence, payload, created_by
  )
  values (
    new.vehicle_id,
    'SERVICE',
    coalesce(new.provider_name || ' service','Service'),
    new.occurred_on,
    'exact',
    jsonb_build_object(
      'service_record_id', new.id,
      'provider_kind', new.provider_kind,
      'total', new.total
    ),
    new.created_by
  )
  on conflict do nothing;
  return new;
end; $function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| user_has_access                     | check_user_id uuid                                                                                                                                                                                                                                                                                                                                                                                                                                  | CREATE OR REPLACE FUNCTION public.user_has_access(check_user_id uuid)
 RETURNS boolean
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public', 'pg_temp'
AS $function$
DECLARE
    is_authorized boolean;
BEGIN
    -- Implement your custom access control logic here
    -- Example: Check if the user exists or has specific permissions
    is_authorized := EXISTS (
        SELECT 1 
        FROM auth.users 
        WHERE id = check_user_id
        -- Add additional conditions as needed, e.g.:
        -- AND some_permission_column = true
    );
    
    RETURN is_authorized;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| validate_plan_insert                |                                                                                                                                                                                                                                                                                                                                                                                                                                                     | CREATE OR REPLACE FUNCTION public.validate_plan_insert()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public', 'extensions', 'pg_temp'
AS $function$
begin
  -- Only allow valid plan values
  if new.plan not in ('free', 'builder', 'pro') then
    raise exception 'Invalid plan value: %. Valid values are: free, builder, pro', new.plan;
  end if;

  -- Only allow valid role values
  if new.role not in ('user', 'helper', 'admin') then
    raise exception 'Invalid role value: %. Valid values are: user, helper, admin', new.role;
  end if;

  return new;
end;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| validate_plan_transition            |                                                                                                                                                                                                                                                                                                                                                                                                                                                     | CREATE OR REPLACE FUNCTION public.validate_plan_transition()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public', 'extensions', 'pg_temp'
AS $function$
begin
  -- Only allow valid plan values
  if new.plan not in ('free', 'builder', 'pro') then
    raise exception 'Invalid plan value: %. Valid values are: free, builder, pro', new.plan;
  end if;
  -- Only allow valid role values
  if new.role not in ('user', 'helper', 'admin') then
    raise exception 'Invalid role value: %. Valid values are: user, helper, admin', new.role;
  end if;
  -- Log plan changes for audit
  if old.plan is distinct from new.plan then
    insert into activity_log (
      entity_type,
      entity_id,
      user_id,
      diff
    ) values (
      'user_profile',
      new.user_id,
      case
        when current_setting('request.jwt.claims', true)::json->>'sub' is not null
        then (current_setting('request.jwt.claims', true)::json->>'sub')::uuid
        else new.user_id
      end,
      jsonb_build_object(
        'before', jsonb_build_object('plan', old.plan),
        'after', jsonb_build_object('plan', new.plan)
      )
    );
  end if;
  -- Log role changes for audit
  if old.role is distinct from new.role then
    insert into activity_log (
      entity_type,
      entity_id,
      user_id,
      diff
    ) values (
      'user_profile',
      new.user_id,
      case
        when current_setting('request.jwt.claims', true)::json->>'sub' is not null
        then (current_setting('request.jwt.claims', true)::json->>'sub')::uuid
        else new.user_id
      end,
      jsonb_build_object(
        'before', jsonb_build_object('role', old.role),
        'after', jsonb_build_object('role', new.role)
      )
    );
  end if;
  return new;
end;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |